version: '3'

vars:
  ASYNC_PROFILER_DIR: "{{.TASK_DIR}}/.local/async-profiler"
  BENCHMARKS_OUTPUT_DIR: "{{.TASK_DIR}}/target/benchmarks"
  BENCHMARKS_JAR: "benchmarks/target/benchmarks.jar"
  JCSTRESS_JAR: "jcstress/target/jcstress.jar"

tasks:

  download-async-profiler-linux-x64:
    desc: "Install async-profiler (Linux x64)"
    platforms:
      - linux
    vars:
      ASYNC_PROFILER_VERSION: "4.1"
      ASYNC_PROFILER_URL: "https://github.com/async-profiler/async-profiler/releases/download/v{{.ASYNC_PROFILER_VERSION}}/async-profiler-{{.ASYNC_PROFILER_VERSION}}-linux-x64.tar.gz"
      ASYNC_PROFILER_ARCHIVE: "async-profiler-{{.ASYNC_PROFILER_VERSION}}-linux-x64.tar.gz"
      VERSION_FILE: "{{.ASYNC_PROFILER_DIR}}/.version"
    cmds:
      - curl -L -o {{.ASYNC_PROFILER_ARCHIVE}} {{.ASYNC_PROFILER_URL}}
      - rm -rf {{.ASYNC_PROFILER_DIR}}
      - mkdir -p {{.ASYNC_PROFILER_DIR}}
      - tar xzf {{.ASYNC_PROFILER_ARCHIVE}} --strip-components=1 -C {{.ASYNC_PROFILER_DIR}}
      - echo "{{.ASYNC_PROFILER_VERSION}}" > {{.VERSION_FILE}}
      - rm {{.ASYNC_PROFILER_ARCHIVE}}
    sources:
      - Taskfile.yml
    generates:
      - "{{.ASYNC_PROFILER_DIR}}/lib/libasyncProfiler.so"
    status:
      - test -f "{{.VERSION_FILE}}" && test "$(cat {{.VERSION_FILE}})" = "{{.ASYNC_PROFILER_VERSION}}"
  download-async-profiler-macos:
    desc: "Install async-profiler (MacOS)"
    platforms:
      - darwin
    vars:
      ASYNC_PROFILER_VERSION: "4.1"
      ASYNC_PROFILER_URL: "https://github.com/async-profiler/async-profiler/releases/download/v{{.ASYNC_PROFILER_VERSION}}/async-profiler-{{.ASYNC_PROFILER_VERSION}}-linux-x64.tar.gz"
      ASYNC_PROFILER_ARCHIVE: "async-profiler-{{.ASYNC_PROFILER_VERSION}}-macos.zip"
      VERSION_FILE: "{{.ASYNC_PROFILER_DIR}}/.version"
    cmds:
      - curl -L -o {{.ASYNC_PROFILER_ARCHIVE}} {{.ASYNC_PROFILER_URL}}
      - rm -rf {{.ASYNC_PROFILER_DIR}}
      - mkdir -p {{.ASYNC_PROFILER_DIR}}
      - tar xzf {{.ASYNC_PROFILER_ARCHIVE}} --strip-components=1 -C {{.ASYNC_PROFILER_DIR}}
      - echo "{{.ASYNC_PROFILER_VERSION}}" > {{.VERSION_FILE}}
      - rm {{.ASYNC_PROFILER_ARCHIVE}}
    sources:
      - Taskfile.yml
    generates:
      - "{{.ASYNC_PROFILER_DIR}}/lib/libasyncProfiler.so"
    status:
      - test -f "{{.VERSION_FILE}}" && test "$(cat {{.VERSION_FILE}})" = "{{.ASYNC_PROFILER_VERSION}}"
  build:
    desc: "Build all modules with Maven"
    cmds:
      - ./mvnw --batch-mode --update-snapshots clean package
    sources:
      - "pom.xml"
      - "*/pom.xml"
      - "**/src/main/java/**"
      - "**/src/test/java/**"
    generates:
      - "**/target/classes/**"
      - "**/target/test-classes/**"
      - "{{.BENCHMARKS_JAR}}"
      - "{{.JCSTRESS_JAR}}"
  run-benchmarks:
    desc: "Run JMH benchmarks"
    deps:
      - build
    cmds:
      - java -jar {{.BENCHMARKS_JAR}} -wi 3 -i 5 -f 1
  run-jcstress:
    desc: "Run JCStress concurrency tests"
    deps:
      - build
    cmds:
      - java -jar {{.JCSTRESS_JAR}}
  run-specific-benchmark:
    desc: "Run a specific benchmark (usage: task run-specific-benchmark -- BenchmarkClassName)"
    deps:
      - build
    cmds:
      - java -jar {{.BENCHMARKS_JAR}} "{{.CLI_ARGS}}" -wi 3 -i 5 -f 1
  run-pool-benchmarks:
    desc: "Run Pool benchmarks"
    deps:
      - build
    cmds:
      - java -jar {{.BENCHMARKS_JAR}} "PoolBenchmark" -wi 3 -i 5 -f 1
  run-actor-benchmarks:
    desc: "Run Actor system benchmarks"
    deps:
      - build
    cmds:
      - java -jar {{.BENCHMARKS_JAR}} "ActorSystemBenchmark" -wi 3 -i 5 -f 1
  run-array-benchmarks:
    desc: "Run AppendOnly array benchmarks"
    deps:
      - build
    cmds:
      - java -jar {{.BENCHMARKS_JAR}} ".*Array.*Benchmark" -wi 3 -i 5 -f 1
  run-jcstress-specific:
    desc: "Run specific JCStress tests (usage: task run-jcstress-specific -- TestPattern)"
    deps:
      - build
    cmds:
      - java -jar {{.JCSTRESS_JAR}} -t "{{.CLI_ARGS}}"
  run-jcstress-pool:
    desc: "Run JCStress tests for Pool implementation"
    deps:
      - build
    cmds:
      - java -jar {{.JCSTRESS_JAR}} -t ".*pool.*"
  run-jcstress-actor:
    desc: "Run JCStress tests for Actor system"
    deps:
      - build
    cmds:
      - java -jar {{.JCSTRESS_JAR}} -t ".*actor.*"
  profile-benchmarks:
    desc: "Profile benchmarks using async-profiler"
    deps:
      - download-async-profiler-linux-x64
      - build
    cmds:
      - mkdir -p {{.BENCHMARKS_OUTPUT_DIR}}
      - |
        java -jar {{.BENCHMARKS_JAR}} \
        "ActorSystemBenchmark" \
        -wi 5 -i 5 -f 1 \
        -prof "async:libPath={{.ASYNC_PROFILER_DIR}}/lib/libasyncProfiler.so;event=wall;output=collapsed;threads=true;dir={{.BENCHMARKS_OUTPUT_DIR}}"
